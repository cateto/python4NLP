쿠팡아이템의 이미지와 텍스트 매칭 정확도 향상 : 

Embedding Technology  활용과 개선 결과

[이미지와 텍스트 매칭 정확도 개선]

상품의 시각 및 텍스트 신호를 활용해 정매칭 리콜률을 대폭 개선한 프로젝트

사람의 매칭 행동을 모방하도록 딥임베딩을 하고, 매칭 효율성을 위해 대규모 병렬계산을 도입

[매칭] 

이 커머스 회사에서 많이 겪는 문제. 중복 상품이 온라인을 도배하면 경쟁력이 약화되고 카탈로그 품질이 떨어진다. 이는 고객 경험과 매출에 부정적 영향을 끼친다. 사람이 직접 매칭하면 쉽지만, 상품 수백만개의 카테고리는 효율적으로 매칭하기가 쉽지 않다. 사람의 인지능력이 머신에게는 없기 때문이다. 따라서, 머신이 대형 카테고리를 매칭할 수 있는 수준으로 사람의 인지능력을 모방할 수 있을까?

[알고리즘 복잡도 고려]

아이템 매칭 한개씩 하면 O(n*n) 시간이 걸림. 모든 상품에 반복해야하기 때문에 아주 복잡함.

매칭 문제는 서브세팅으로 해결하는 것이 자연스럽다.

(= 한 상품에 대해 정매칭 가능성이 가장 높은 후보 상품의 서브 셋트를 제공하는 것이다.)

서브세팅은 한 상품의 매칭 후보가 적을 때 효과적이다. 

매칭 문제 =검색문제 동일하다고 보고, 검색 리콜률을 최적화 시켰다.

[검색 방식]

문서유사도를 측정하기 위해 20년 이상 된 알고리즘 옵션을 동반한 워드 카운트 히스토그램 기반이다.

이 옵션은 핵심에서 벗어나지 않으면서 히스토그램에 많은 변화를 준다. 따라서, 최적화가 가능하지 않다. 이 접근법은 ES에서 지원함.

두번째는 임베딩 벡터 기반의 최신 검색 방법. 임베딩 벡터 생성을 위해 심층 신경망에 기반을 둔다. 큰 차이는 임베딩 모델이 임베딩 벡터를 자주 최적화한다는 것이다. 따라서 전통적인 워드카운트 히스토그램 보다는 더 나은 성능을 제공한다. 이 접근법은 Faiss에서 지원함.

파워 서치에 임베딩 벡터 유사도를 활용하는것이 목표!

[딥임베딩]

임베딩이란 유클리디언 벡터 공간으로 부터 비롯된 맵.

딥임베딩은 심층신경망을 활용한 임베딩 기술이다.

이 도메인은 인지된 유사성, 사람만이 인지할 수 있는 유사성을 의미한다. 이는 머신으로의 전이학습 및 척도화가 불가능한 수준의 유사성이다. 명확히 정의된 거리를 기반으로 메트릭 공간에서 공식적이고 체계화된 방식을 통해 이 유사도를 정량화 및 최적화 할 수 있다.

즉, 임베딩 기반의 파워서치는 최적화 및 성능 개선의 기회를 제공한다. 업계에서는 이미 해당 기술의 장점을 활용하여 당면한 문제를 해결하고 있다.

[임베딩 기술의 세가지 요소]

데이터, 임베딩 연산, 그리고 유사도 검색 및 군집화

1) 데이터 : 쿠팡에서 수집된 데이터베이스에는 수십억개의 상품이미지, 상품명, 상품 속성이 존재한다. 더불어 고객과의 상호작용을 통해 수집한 선호도 및 구매데이터도 있다. 이 데이터 소스는 고객지원 및 고객감동의 미션 수행을 위해 아주 중요한 정보를 포함한다.

2) 임베딩 플랫폼 : 효율적인 추출, 유사도 기반의 상품검색 및 군집화를 통해 그 목적을 달성한다. 임베딩 추출은 데이터 공간에서 유클리디안 거리 공간으로의 매핑을 구현한다. 사람만이 인지할 수 있는 유사성을 재현하여 상품간 유사도를 정량화 및 최적화한다.

3) 클러스터링, 유사도 검색 : 쿠팡의 유스케이스에 부합하도록 상품을 쿼리 혹은 군집화 하여 유사도 정보를정량화 및 최적화 한다. 이러한 프로세스를 지원, 활성화 할 수 있는 임베딩 기반 플랫폼이 필요하다.

[딥임베딩의 플랫폼]

계산을 더욱 효율적으로 하기 위해 각 디바이스에서 배치 연산을 위한 GPU 기반의 대규모 병렬화가 가능하다. 단일 머신 뿐만아니라 머신 군집 수준에서도 대규모 병렬화가 가능하다. 본질적으로 임베딩 벡터는 병렬적인 연산이 가능하기 때문이다. 본 프로젝트에서는 추론단계의 임베딩 연산에 집중한다. 신경망은 우리가 원하는 수준으로 학습됬다고 전제하며 본 세션에서는 신경망학습에 대해서는 다루지 않을것이다.

[효율적 벡터 유사도 검색]

Faiss가 바로 벡터 유사도 인덱싱 및 검색을 수행하는 플랫폼이다. 수백 수천만 상품의 인덱싱을 수행한다. 모든 인풋에 대해 Faiss 인덱싱을 수행한다. 이 과정에서 '이미지'와 '상품명'의 임베딩 벡터, 총 두가지 인덱스를 추출한다. 또한 Faiss의 배치 검색기능으로 상품 클러스터릴 조회 및 구조화하고 동일한 유사도의 모든 상품을 검색한다.

[비쥬얼, 텍스트 클러스터링]

시각 및 텍스트 클러스터란 이미지 및 텍스트 임베딩을 통해 추출한 모든 후보를 의미한다. 요청상품의 유사도가 특정 기준을 충족하는 경우에 모든 클러스터가 후보군에 포함된다. 상품 클러스터는 특정 기준을 충족하는 모든 정매칭 후보를 의미한다. (정매칭 후보?) 전통적인 추출방식은 상품순위에 따라 나열했다면, 이제는 유사도가 비슷한 매칭후보를 추출하여 코호트(공통적인 특성을 가진 사람들의 집단)를 구성할 수 있다.

[어떻게 리콜률을 측정하는가?]

![image-20220106153712333](https://raw.githubusercontent.com/cateto/resources/main/img/image-20220106153712333.png)

이렇게 수천 수백만개의 상품의 이미지 및 텍스트 임베딩 벡터를 연산할 수 있다. 임베딩 벡터 인덱싱을 통해 매칭 후보군 추출 및 연산이 가능합니다. 매칭 후보 추출 후 리콜률을 계산하여 만족할만한 성능이 나왔는지 확인합니다. 하지만 여기서 중요한 질문을 드리겠습니다. 수천만개 상품이 있는 카테고리의 리콜률을 실제로 계산할 수 있을까요? 이를 위해 카테고리 내 전 상품 혹은 일부 요청 상품에 대한 정매칭이 필요합니다. 그러나 방대한 카테고리의 리콜률 계산은 현실적으로 어렵습니다. 일부라도 모든 정매칭 대상을 수기로 검수해야 하기 때문입니다. 그렇다면 리콜률을 계산하지 않고도 개선치를 측정할 수 있을까요? 가능합니다 .바로 베이스라인과 비교하는 것입니다. 베이스라인에서 못찾은 정매칭을 대안책이 제공해준다면 리콜률 개선이 명백해집니다. 이 논리에 따라 각각 베이스라인과 대안 생성 파이프라인을 쿼리합니다. 이제 비교가능한 두쌍의 후보가 추출되고, 대안책이 베이스라인보다 더 많은 정매칭을 제공했거나 완전히 새로운 후보를 찾았다면 대안책이 베이스라인의 후보군을 보완한다는게 명확해진다.

[본 실험의 프레임워크]

동일한 요청상품을 ES와 FAISS에 각각 쿼리한 후 매칭 후보군을 추출하는 방식으로 파이프라인을 운용합니다. 따라서 베이스라인 후보군 A와 대안 후보군 B를 각각 추출합니다. 후보군 A와 B의 정매칭 개수를 계산하여 베이스라인과 대안책의 리콜률을 비교합니다. 

[실험 상세 내용]

![image-20220106154638534](https://raw.githubusercontent.com/cateto/resources/main//img/image-20220106154638534.png)

1. 타겟 카테고리 상품에서 요청 상품을 무작위로 선택
2. ES 후보군 중 매칭율이 가장 높은 상품 추출
3. 이미지 및 텍스트 임베딩 후보군 중 가장 높은 상품 선정
4. 요청 상품과 매칭된 후보군을 비교해 매칭인지 오매칭인지 기록
5. ES, 이미지 및 텍스트 임베딩 접근법 간 정탐값(TP) 비교

[실험 결과]

![image-20220106154910943](https://raw.githubusercontent.com/cateto/resources/main//img/image-20220106154910943.png)

2000만개의 상품이 있는 뷰티 카테고리의 실험 결과

: 이미지 및 텍스트 임베딩을 통해 ES가 추출 못한 정매칭 후보군을 확인한 결과, 상품간 중복값이 낮은 것을 확인할 수 있다. 이것을 보완 현상이라고 명명한다. 앙상블 학습법에서 다수의 약학습기가 결합하여 강학습기를 제공하는 현상에서 유래된 용어이다.

![image-20220106155055146](https://raw.githubusercontent.com/cateto/resources/main//img/image-20220106155055146.png)

1700만개가 있는 푸드 카테고리의 실험 결과

: ES의 정매칭과 별개로 이미지 및 텍스트 임베딩을 통해 각각 73%, 36% 보완된 정매칭율을 추출했습니다. 이미지와 텍스트 모델 간 정매칭된 쌍의 중복률은 단지 16%. 가장 중요한 것은 중복을 제외한 정매칭 개선율이 106%이며, ES 대비 현저히 높은 수준이다.

[이미지 임베딩과 텍스트 임베딩의 보완 기능]

![image-20220106155324233](https://raw.githubusercontent.com/cateto/resources/main//img/image-20220106155324233.png)

이미지와 텍스트 임베딩이 서로를 보완한다. 이미지 임베딩은 텍스트 임베딩이 제공 못하는 정매칭을 제공하며, 텍스트 임베딩은 이미지 임베딩이 제공 못하는 정매칭을 제공한다.

상단 그래프는 텍스트 임베딩에서 추출하지 못한 정매칭을 이미지 임베딩에서 추출한 스코어 히스토그램.

(= 해당 후보군이 이미지 속성을 더 많이 보유하고 있다는 뜻이다.)

하단 그래프는 이미지 임베딩에서 추출하지 못한 정매칭을 텍스트임베딩에서 추출한 스코어 히스토그램.

(= 해당 후보군이 텍스트 속성을 더 많이 보유하고 있다는 뜻이다.)



[소프트웨어 아키텍처]

![image-20220106155930203](https://raw.githubusercontent.com/cateto/resources/main//img/image-20220106155930203.png)

Embedding pipeline을 ES pipeline과 나란히 운용한다. 이 파이프라인에서 추출한 후보를 조합하기만 하면 된다. ES만 쓰는것보다 확실한 정매칭이 나온다. 조합 모듈을 적용해 더욱 일반화할 수 있다. 총 세개의 파이프라인을 운영하는데, 특히 추가 정보가 있는 경우 조합이 리콜률도 개선한다는 가정입니다.



[리콜 부스팅 파이프라인을 이미지와 텍스트에 적용]

![image-20220106162234308](https://raw.githubusercontent.com/cateto/resources/main//img/image-20220106162234308.png)

인덱싱, 검색 및 모니터링, 프로덕션 효율성, 척도화 및 신뢰성 제공

인덱싱과 검색 파이프라인 모두 초당 3500개의 요청을 처리합니다. 쿼리 레이턴시는 100ms에서 1초, TP90은 900ms입니다.

[플랫폼 구축]

유연하고 설정가능한 임베딩 플랫폼을 적용하기 위해  다음과 같이 소프트웨어 하위 시스템과 모듈을 구축하였다.

![image-20220106162433614](https://raw.githubusercontent.com/cateto/resources/main//img/image-20220106162433614.png)

아직 미개발 : 임베딩 유사도를 감독하는 마스터 API와, 카테고리 속성을 반영하기 위한 별개의 로직 모듈도 고려중입니다. 타팀이 도입해 확장할 수 있는 SDK도 고민중입니다. 적용사례가 많아지면  모델 관리 모듈을 구축해 여러 DNN 모델과 임베딩 벡터를 지원해 저장소 최적화와 비용절감을 합니다. 

[Outro]

이처럼 임베딩은 범용적으로 적용할 수 있는 일반적인 기술입니다. 

![image-20220106162700851](https://raw.githubusercontent.com/cateto/resources/main//img/image-20220106162700851.png)

플랫폼 사용 팀 

1) 카탈로그 아이템 매칭 - Deduplication (Intro에 언급)

2) Search query understanding - Query Similarities

인간이 인지할수있는 정도의 유사성은 임베딩 벡터 유사도 기술로 구현할 수 있다.

